<!--
TODO: –ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞

–í–•–û–î–Ø–©–ò–ï –ü–†–û–ü–°–´:
- sourceElementId: String - ID DOM —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–µ
- userOptions: Object - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–ø—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–æ–≤:
  {
    // Core displacement parameters
    displacementScale: 65,
    aberrationIntensity: 2.8,
    displacementCurvature: 1.8,

    // Glass material properties
    glassBlur: 25,
    glassSaturation: 185,
    refractionDepth: 2.0,
    surfaceReflection: 0.45,

    // Light and shadow
    highlightIntensity: 0.75,
    highlightSpread: 1.1,
    highlightHue: 210,
    shadowDepth: 0.4,

    // Advanced effects
    glassBrightness: 115,
    glassContrast: 118,
    glassTintHue: 210,
    glassTintOpacity: 0.38,
    noiseStrength: 0.22,

    // Shader distortion parameters
    shaderCornerRadius: 0.2,
    shaderDistortionStart: 0.3,
    shaderDistortionEnd: 0.2,
    shaderDistortionOffset: 0.15,
    shaderScalingStart: 0,
    shaderScalingEnd: 1
  }
- intensity: Number (0-1) - –æ–±—â–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞

–°–õ–û–¢–´:
- default: –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- hover: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
- active: –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨:
- –°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ createEffectOptions(userOptions)
- –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –æ–ø—Ü–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —Å–ª–æ–∏ —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞

–ö–ê–†–¢–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø (—Å—Ç–∞—Ä–æ–µ ‚Üí –Ω–æ–≤–æ–µ):

–ö–û–ú–ü–û–ù–ï–ù–¢–´:
- GlassEffect.vue (–º–æ–Ω–æ–ª–∏—Ç) ‚Üí GlassEffect.vue + 5 –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- SvgFilter.vue ‚Üí GeFilter.vue (+ DOM source –ª–æ–≥–∏–∫–∞)
- effect-options.js ‚Üí GlassEffectDefaults.js

–°–¢–†–£–ö–¢–£–†–ê –°–õ–û–ï–í:
–°—Ç–∞—Ä–æ–µ:
  <section class="liquid-glass">
    <SvgFilter />
    <div class="liquid-glass__card" ref="glassElementRef">
      <div class="liquid-glass__layer--dom-source" />
      <div class="liquid-glass__layer--highlight" />
      <div class="liquid-glass__layer--noise" />
      <div class="liquid-glass__content"><slot /></div>
      <div class="liquid-glass__layer--light" />
      <div class="liquid-glass__outline" />
    </div>
  </section>

–ù–æ–≤–æ–µ:
  <div class="glass-effect">
    <GeFilter /> 
    <div class="glass-effect__content"> - 3 —Å–ª–æ—Ç–∞ –≤–º–µ—Å—Ç–æ 1 

    </div>
    <GeHighlight /> - –±—ã–ª–æ liquid-glass__layer--highlight
    <GeNoise />  - –±—ã–ª–æ liquid-glass__layer--noise
    <GeLight /> - –±—ã–ª–æ liquid-glass__layer--light 
    <GeOutline - –±—ã–ª–æ liquid-glass__outline + card shadow 



    –ü–†–û–ü–°–´:
- glassConfig ‚Üí userOptions
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–ø—Å—ã ‚Üí –æ–±—ä–µ–∫—Ç—ã { options, intensity }

CSS –ö–õ–ê–°–°–´:
- .liquid-glass ‚Üí .glass-effect
- .liquid-glass__layer--* ‚Üí .glass-* –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- .liquid-glass__card ‚Üí —É–¥–∞–ª–µ–Ω (–ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ GeOutline)
-->
<template>
  <div class="glass-effect">
    <GeFilter :filterProps="filterProps" />

    <div class="glass-effect__content">
      <slot />
    </div>

    <GeHighlight :options="{ highlightReflection }" :intensity />

    <GeNoise :options="{ noiseStrength, noiseRefractionDepth }" :intensity />

    <GeLight :options="{ lightIntensity, lightSpread, lightHue }" :intensity />

    <GeOutline
      :options="{
        outlineIntensity,
        outlineGlassTintHue,
        surfaceReflection,
        shadowDepth,
      }"
      :intensity
    />
  </div>
</template>

<script setup>
import { computed, ref, onMounted, onBeforeUnmount } from "vue";
import { createEffectOptions } from "./GlassEffectDefaults.js";
import { createFilterProps } from "../layer-filter-props.js";
import { ShaderDisplacementGenerator } from "../filter-displacement-generator.ts";
import GeFilter from "./GeFilter.vue";
import GeHighlight from "./GeHighlight.vue";
import GeNoise from "./GeNoise.vue";
import GeLight from "./GeLight.vue";
import GeOutline from "./GeOutline.vue";

const props = defineProps({
  sourceElementId: {
    type: String,
    default: "",
  },
  userOptions: {
    type: Object,
    default: () => ({}),
  },
  intensity: {
    type: Number,
    default: 1,
    validator: (value) => value >= 0 && value <= 1,
  },
});

const opts = createEffectOptions(props.userOptions);

// Filter state
const filterId = `apple-liquid-glass-${Math.random().toString(36).slice(2)}`;
const filterReady = ref(false);
const shaderMapUrl = ref("");

// Generate shader displacement map
const generateShaderDisplacementMap = () => {
  console.log('üé® Generating shader displacement map...');
  console.log('Shader options:', {
    width: 400,
    height: 400,
    cornerRadius: opts.shaderCornerRadius,
    distortionStart: opts.shaderDistortionStart,
    distortionEnd: opts.shaderDistortionEnd,
    distortionOffset: opts.shaderDistortionOffset,
    scalingStart: opts.shaderScalingStart,
    scalingEnd: opts.shaderScalingEnd,
  });

  const generator = new ShaderDisplacementGenerator({
    width: 400,
    height: 400,
    cornerRadius: opts.shaderCornerRadius,
    distortionStart: opts.shaderDistortionStart,
    distortionEnd: opts.shaderDistortionEnd,
    distortionOffset: opts.shaderDistortionOffset,
    scalingStart: opts.shaderScalingStart,
    scalingEnd: opts.shaderScalingEnd,
  });
  const url = generator.updateShader();
  console.log('üé® Generated shader URL length:', url.length);
  console.log('üé® Setting filterReady to true');

  filterReady.value = true;
  shaderMapUrl.value = url;
  generator.destroy();
};

// Create filter props
const filterProps = computed(() =>
  createFilterProps(opts, props.intensity, {
    filterReady: filterReady.value,
    filterId,
    shaderMapUrl: shaderMapUrl.value,
  })
);

// Initialize shader on mount
onMounted(() => {
  console.log('üöÄ GlassEffect mounted, generating shader...');
  generateShaderDisplacementMap();
  console.log('üöÄ GlassEffect shader generation complete');
});

const {
  lightIntensity,
  lightSpread,
  lightHue,
  highlightReflection,
  noiseStrength,
  noiseRefractionDepth,
  outlineIntensity,
  outlineGlassTintHue,
  surfaceReflection,
  shadowDepth,
} = opts;
</script>

<style scoped>
.glass-effect {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  border-radius: inherit;
}

.glass-effect__content {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  border-radius: inherit;
  overflow: hidden;
  cursor: pointer;
  isolation: isolate;
  will-change: transform;
  transition: box-shadow 0.25s ease, border 0.25s ease, background 0.25s ease;
  z-index: 1;
}
</style>
