# Track if any media was updated
MEDIA_UPDATED=false

echo "ðŸŽ¥ Checking for new/updated videos to compress..."

# Check if there are any MP4 files in the videos directory
if [ -d "public/videos" ]; then
  # Check if there are any NEW .mp4 files staged for commit (not deleted)
  if git diff --cached --name-only --diff-filter=AM | grep -q "public/videos/.*\.mp4$"; then
    echo "ðŸ“¹ Found MP4 files staged for commit"
    echo "ðŸŽ¬ Running video compression..."
    npm run compress:videos

    MEDIA_UPDATED=true
    echo "âœ… Video compression completed"
  else
    echo "â­ï¸  No new MP4 files found in staged changes"
  fi
else
  echo "â­ï¸  No videos directory found"
fi

echo ""
echo "ðŸ–¼ï¸  Checking for new/updated images to compress..."

# Check if there are any image files in the images directory
if [ -d "public/images" ]; then
  # Check if there are any NEW image files staged for commit (not deleted)
  if git diff --cached --name-only --diff-filter=AM | grep -qE "public/images/.*\.(png|jpg|jpeg|webp)$"; then
    echo "ðŸ“¸ Found image files staged for commit"
    echo "ðŸ–¼ï¸  Running image compression..."
    npm run compress:images

    MEDIA_UPDATED=true
    echo "âœ… Image compression completed"
  else
    echo "â­ï¸  No new image files found in staged changes"
  fi
else
  echo "â­ï¸  No images directory found"
fi

echo ""
echo "ðŸ“„ Checking for new/updated documents..."

# Check if there are any document files in the documents directory
if [ -d "public/documents" ]; then
  # Check if there are any NEW document files staged for commit (not deleted)
  if git diff --cached --name-only --diff-filter=AM | grep -qE "public/documents/.*\.pdf$"; then
    echo "ðŸ“‹ Found document files staged for commit"

    MEDIA_UPDATED=true
    echo "âœ… Documents detected for CDN sync"
  else
    echo "â­ï¸  No new document files found in staged changes"
  fi
else
  echo "â­ï¸  No documents directory found"
fi

# If any media was updated, prepare manifest and sync to CDN
if [ "$MEDIA_UPDATED" = true ]; then
  echo ""
  echo "â˜ï¸  Preparing media manifest and syncing to CDN..."

  # Generate manifest with hashed filenames
  npm run media:prepare

  # Add manifest to staging (not ignored)
  git add public/media-manifest.json 2>/dev/null || true

  # Sync to CDN (all media types)
  echo "ðŸ“¤ Uploading to CDN..."
  npm run cdn:sync

  echo "âœ… Media synced to CDN"
fi